Based on the excelent work by Corvin Koegler (PixelEditor)